<!DOCTYPE html>

<!-- https://www.w3schools.com/howto/howto_js_rangeslider.asp -->
<html>
<head>
<meta charset="utf-8" />
<title>Sunsim Steuerprogramm</title>
<script src="/socket.io/socket.io.js"></script>
<link rel="icon" type="image/png" href="images/favicon.ico">
<style>
.dropbtn {
  background-color: #3498DB;
  color: white;
  padding: 16px;
  font-size: 16px;
  border: none;
  cursor: pointer;
}

.dropbtn:hover, .dropbtn:focus {
  background-color: #2980B9;
}

.dropdown {
  position: relative;
  display: inline-block;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f1f1f1;
  min-width: 160px;
  overflow: auto;
  box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
  z-index: 1;
}

.dropdown-content a {
  color: black;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
}

.dropdown a:hover {background-color: #ddd;}

.show {display: block;}
</style>
</head>
<style>
#text {
  font-family: Arial, Verdana, Helvetica, sans-serif;
  font-size: 14px;
  text-transform: none;
  overflow: auto;
  text-align: left;
  margin-top:4px;
  margin:6px;
  width:97vw;
  border: 2px solid black;
  border-radius: 5px;
  height:15vh;
}

#text {
  font-family: Arial, Verdana, Helvetica, sans-serif;
  font-size: 14px;
  text-transform: none;
  overflow: auto;
  text-align: left;
  margin-top:4px;
  margin:6px;
  width:97vw;
  border: 2px solid black;
  border-radius: 5px;
  height:15vh;
}

.buttonload {
  background-color:blue;
  border-radius: 30px;
  // background-color: #04AA6D; /* Green background */
  border: none; /* Remove borders */
  color: white; /* White text */
  padding: 12px 24px; /* Some padding */
  font-size: 16px; /* Set a font-size */
}

.buttonload:hover {
	background-color:lightskyblue;
}


/* Add a right margin to each icon */
.fa {
  margin-left: -12px;
  margin-right: 8px;
}

.menu-button{
	background: none;
    border: none;
}

.sidenav {
  height: 30%;
  width: 0;
  background-color: white;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  overflow-x: hidden;
  transition: 0.5s;
  padding-top: 60px;
  border-width:2px;
  border-color:black
}

.sidenav a {
  padding: 8px 8px 8px 32px;
  text-decoration: none;
  font-size: 25px;
  color: black;
  display: block;
  transition: 0.3s;
}

.sidenav a:hover {
  color: #a1a1a1;
}

.sidenav .closebtn {
  position: absolute;
  top: 0;
  right: 25px;
  font-size: 36px;
  margin-left: 50px;
}

.cref-command {
	width: 250px;
    display: inline-block;
}

.cref-descr{

}

.titlecolumn{
	vertical-align: top;
	font-weight: bold
}

</style>
<body  onload="initPage();">
<div id="mySidenav" class="sidenav">
  <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
  <a href="#" onclick="toggleAdmin()">Verwaltung an/aus</a>
  <a href="#" onclick="toggleProtocol()">Protokoll an/aus</a>
  <a href="#" onclick="toggleMesssages()">Meldungen an/aus</a>
  <a href="#" onclick="toggleCommandReference()">Befehlsliste an/aus</a>
<!--  <a href="#">Contact</a> -->
</div>
<header id="pageheader">
<table style="width:100%" ><tr><td>
<button aria-label="Toggle navigation bar" aria-expanded="false" id="menu" class="menu-button" type="button" onclick="openNav()">
<svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true">
<path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22">
</path>
</svg>
</button>
</td>
<td>
	<h1>sunsim 1000</h1>
</td>
<!--<td>
	<h1>Version 1.0/1.0.0</h1>
</td> -->
<!--<td>
<div><span id="currenttime"></span></div>
</td> -->
<td>
      <div style="margin-right:15px;text-align:right" id="logo_opacity"><img style="width:200px" src="images/hmm_logo.jpg"></div>
</td>
</tr>
</table>
</header>


<script>
function openNav() {
  document.getElementById("mySidenav").style.width = "250px";
  document.getElementById("mySidenav").style.borderStyle = "solid";
  document.getElementById("mySidenav").style.borderRadius = "8px";
}

function closeNav() {
  document.getElementById("mySidenav").style.width = "0";
  document.getElementById("mySidenav").style.borderStyle = "none";
  document.getElementById("mySidenav").style.borderRadius = "0";
}
</script>
<div style="border-style:solid;border-radius:5px;padding:5px">
<table style="width:100%" role="presentation">
	<tr>
		<td style="font-weight:bold">
			<label>Status:</label>
		</td>
		<td>
			<span class= "status" id="state">Keine Verbindung</span>
		</td>
		<td colspan="1">
			<span class= "status" id="devicetime"/>
		</td><td></td>
		<td>
			<div>
				<button id="startbutton" class="buttonload">
					<i class="fa fa-refresh fa-spin"></i>Start</button>
			</div>
		</td>
	</tr>	
	<tr>
		<td class="titlecolumn">
			<label>Position:</label>
		</td>
		<td>
			<span id="demoPOS" style="font-weight:bold;color:red"></span>	
			<div class="slidecontainer">
			  <input type="range" min="-15" max="15" value="0" class="slider" id="POSRange">
			</div>
		</td>
		<td>
			<span>Intensität-Einst. lokal: </span><span id="demoPOT" style="font-weight:bold;color:red"></span>	
			<div class="slidecontainer">
			  <input type="range" min="0" max="100" value="0" class="slider" id="POTRange" disabled>
			</div>
		</td>
	</tr>	
	<tr>
		<td class="titlecolumn">
			<label>Intensität:</label>
		</td>
		<td>
			<span>Visible:</span> <span id="demoVIS" style="font-weight:bold;color:red"></span>	
			<div class="slidecontainer">
			  <input type="range" min="0" max="100" value="50" class="slider" id="VISRange">
			</div>
		</td>
		<td>
			<span>Nahes IR:</span> <span id="demoNIR" style="font-weight:bold;color:red"></span>
			<div class="slidecontainer">
				<input type="range" min="0" max="100" value="50" class="slider" id="NIRRange">
			</div>
		</td>
		<td>
			<span>Infrarot:</span> <span id="demoIR" style="font-weight:bold;color:red"></span>
			<div class="slidecontainer">
				<input type="range" min="0" max="100" value="50" class="slider" id="IRRange">
			</div>
		</td>
		<td>
			<div>
			<button id="setvaluesbutton" class="buttonload">
				<i class="fa fa-refresh fa-spin"></i>
				Intensitätswerte setzen
			</button>
			</div>
		</td>
	</tr>
	<tr>
		<td class="titlecolumn">
			<label>Aktuell:</label>
		</td>
		<td>
			<span>Visible:</span> <span id="demoVIS" style="font-weight:bold;color:red"></span>	
			<div >
				<span class="actualvalues" id="vis1act">?</span>
				<span class="actualvalues" id="vis2act">?</span>
				<span class="actualvalues" id="vis3act">?</span>
				<span class="actualvaluesunit" >A</span>
			</div>
		</td>
		<td>
			<span>Nahes IR:</span> <span id="demoNIR" style="font-weight:bold;color:red"></span>
			<div>
				<span class="actualvalues" id="nir1act">?</span>
				<span class="actualvalues" id="nir2act">?</span>
				<span class="actualvaluesunit" >A</span>
			</div>
		</td>
		<td>
			<span>Infrarot:</span> <span id="demoIR" style="font-weight:bold;color:red"></span>
			<div >
				<span class="actualvalues" id="ir1act">?</span>
				<span class="actualvalues" id="ir2act">?</span>
				<span class="actualvalues" id="ir3act">?</span>
				<span class="actualvaluesunit" >W</span>
			</div>
		</td>
		<td>
		</td>
	</tr>
	<tr>
		<td class="titlecolumn">
			<label>Temperatur:</label>
		</td>
		<td colspan="2">
			<span>Lampen:</span> <span id="demoLampTemperature" style="font-weight:bold;color:red"></span>	
			<div >
				<span class="actualvalues" id="tlamp1">?</span>
				<span class="actualvalues" id="tlamp2">?</span>
				<span class="actualvalues" id="tlamp3">?</span>
				<span class="actualvaluesunit" >°C</span>
			</div>
		</td>
		<td>
			<span>Elektronikgehäuse Lufttemperatur:</span> <span id="demoRackTemperature" style="font-weight:bold;color:red"></span>
			<div>
				<span class="actualvalues" id="telectronic">?</span>
				<span class="actualvaluesunit" >°C</span>
			</div>
		</td>
		<td>
		</td>
	</tr>
</table>
</div>

<div id="protocolpart" style="display:none">
	<div id="protocolcontents">
	<ul id="protlist">
	</ul>
	</div>
</div>
<div id="adminpart" style="display:none">
	<div id="admincontents">
	<ul>
	<li><span class="cref-command">Seriennummer</span><span class="cref-descr" id="serial"></span></li>
	<li><span class="cref-command">Betriebsstunden</span><span class="cref-descr" id="ophours"></span></li>
	<!-- <li><span class="cref-command">Systemzeit</span><span class="cref-descr" id="systime"></span></li> -->
	<li><button class="buttonload" onclick="setSysTime()">PC Zeit übernehmen</button></li>
	</div>
</div>
<div id="debugpart" style="display:none">
	<div id="text"></div>
	<div id="tosend">
	 <form id="sendform" name="sendform">
	 <textarea style="margin-top:4px; margin:6px; border:2px solid black; border-radius: 5px; width:97vw; height:10vh; font-size:20px;"
	  id="msg" name="msg" 
	 placeholder="Messages appear in the box above. Type in your message here then click 'Send' or press Enter."></textarea>
	 <br /> 
	 <input class="buttonload" type="button" name="send" value="Send" onclick='send_msg("");' />
	</form>
	</div>
</div>
<div id="commandpart" style="display:none">
	<div id="commands">
	<ul>
	<li><span class="cref-command">#READCHANNEL XX</span><span class="cref-descr">Messwert ADC Kanal XX (0-15) in mV</span></li>
	<li><span class="cref-command">#READCHANNELS</span><span class="cref-descr">Messwerte aller ADC Kanäle in mV</span></li>
	<li><span class="cref-command">#SETDAC XX YYYY</span><span class="cref-descr">Setzt Steuerspannung XX (0-7) auf YYYY (0- 4095)</span></li>
	<li><span class="cref-command">#READDAC XX</span><span class="cref-descr">Liefert Steuerspannung XX (0-7) als Zahlenwert (0- 4095)</span></li>
	<li><span class="cref-command">#STATUS</span><span class="cref-descr">Liefert den Status (Bereit/Aktiv/Überhitzung)</span></li>
	<li><span class="cref-command">#ENABLEVIS</span><span class="cref-descr">Schaltet die Lampen für den sichbaren Bereich ein</span></li>
	<li><span class="cref-command">#DISABLEVIS</span><span class="cref-descr">Schaltet die Lampen für den sichbaren Bereich aus</span></li>
	<li><span class="cref-command">#ENABLEIR</span><span class="cref-descr">Schaltet die Lampen für den Infrarot Bereich ein</span></li>
	<li><span class="cref-command">#DISABLEIR</span><span class="cref-descr">Schaltet die Lampen für den Infrarot Bereich aus</span></li>
	<li><span class="cref-command">#ENABLENIR</span><span class="cref-descr">Schaltet die Lampen für den nahen Infrarot Bereich ein</span></li>
	<li><span class="cref-command">#DISABLENIR</span><span class="cref-descr">Schaltet die Lampen für den nahen Infrarot Bereich aus</span></li>
	<li><span class="cref-command">#READTEMPERATURE X</span><span class="cref-descr">Liest die Temperatur des Sensors X (0-3) in °C</span></li>
	<li><span class="cref-command">#READTEMPERATURES</span><span class="cref-descr">Liest die Temperaturen der Sensoren in °C</span></li>
	<li><span class="cref-command">#TIME</span><span class="cref-descr">Liest die Zeit yyyy-mm-ddThh:mm:ss</span></li>
	<li><span class="cref-command">#SETTIME</span><span class="cref-descr">Setzt die Zeit yyyy-mm-dd hh:mm:ss</span></li>
	<li><span class="cref-command">#START</span><span class="cref-descr">Schaltet die Lampen ein</span></li>
	<li><span class="cref-command">#STOP</span><span class="cref-descr">Schaltet die Lampen aus</span></li>
	<li><span class="cref-command">#READOPS</span><span class="cref-descr">Liest Betriebszeit</span></li>
	<li><span class="cref-command">%SERIAL</span><span class="cref-descr">Liest die Seriennummer</span></li>
	</ul>
	</div>
</div>

<script>

var sliderPOS = document.getElementById("POSRange");
var sliderIR = document.getElementById("IRRange");
var sliderNIR = document.getElementById("NIRRange");
var sliderVIS = document.getElementById("VISRange");
var outputPOS = document.getElementById("demoPOS");
var outputIR = document.getElementById("demoIR");
var outputNIR = document.getElementById("demoNIR");
var outputVIS = document.getElementById("demoVIS");
var startstop = document.getElementById("startbutton");
var setvalues = document.getElementById("setvaluesbutton");
var debug = document.getElementById("debugbutton");

outputPOS.innerHTML = sliderPOS.value + "°"; // Display the default slider value
outputIR.innerHTML = sliderIR.value + "%"; // Display the default slider value
outputNIR.innerHTML = sliderNIR.value+ "%"; // Display the default slider value
outputVIS.innerHTML = sliderVIS.value+ "%"; // Display the default slider value

let protocol = new Object();

let vis_dac = [0,1,2];
let nir_dac = [3,4,5];
let ir_dac = [6,7];

// Update the current slider value (each time you drag the slider handle)
sliderPOS.oninput = function() {
  outputPOS.innerHTML = this.value+ "°";
};
sliderIR.oninput = function() {
  outputIR.innerHTML = this.value+ "%";
};
sliderNIR.oninput = function() {
  outputNIR.innerHTML = this.value+ "%";
};
sliderVIS.oninput = function() {
  outputVIS.innerHTML = this.value+ "%";
};

startstop.onclick = function() {
	if (startstop.innerText=="Start")
		// new protocol
	{
		protocol.name = Now().toString().replace(" ", "-");
		protocol.entries = new Array();
	}
	if (startstop.innerText=="Stop"){
		if (protocol && protocol.entries){
		let protstr = "";
		for (var i = 0; i<protocol.entries.length; i++)
			protstr = protstr + getProtocolString(protocol.entries[i]) + '\n';
		send("%WRITEPROTOCOL " + protstr);
		// end protocol
		}
	}
	send_msg("#STARTSTOP " + sliderPOS.value + " " + sliderVIS.value + 
		" " + sliderNIR.value + " " + sliderIR.value +"\n");
};

setvalues.onclick = function(){
	send_msg("#SETVALUES " + sliderPOS.value + " " + sliderVIS.value + 
		" " + sliderNIR.value + " " + sliderIR.value + "\n");
};

setSysTime = function(){
	let dt=new Date();
	let cmd = "#SETTIME "+dt.getFullYear()+"-"+(dt.getMonth()+1)+"-"+dt.getDate() + " " + 
		dt.getHours()+":"+dt.getMinutes()+":"+dt.getSeconds();
	send_msg(cmd);
	send_msg("#TIME");
};

toggleProtocol = function(){
	if( document.getElementById("protocolpart").style.display == 'block')
		document.getElementById("protocolpart").style.display = 'none';
	else
	{
		var ul = document.getElementById("protlist");
		ul.innerHTML = "";
		if (protocol && protocol.entries){
			for (var i = 0; i<protocol.entries.length; i++){
			var li = document.createElement("LI");
			li.innerHTML = '<span style="padding-right:5px;">' + 
				getProtocolString(protocol.entries[i]);
				'</span>';
			ul.appendChild(li);
			}
		document.getElementById("protocolpart").style.display = 'block';
		}
	}
};

function testsend(){
let data = "27.08.2024,10:48:26,30.70,32.20,29.20,23.80,0.1,0,849,850,0,0,0,0\n \
27.08.2024,10:42:26,30.70,32.20,29.20,23.80,0.1,0,849,850,851,0,0,0\n \
27.08.2024,10:42:33,30.70,31.50,29.20,23.60,0.1,0,849,849,849,0,0,0\n \
27.08.2024,10:42:44,31.20,32.40,29.20,23.60,0.1,0,849,849,848,0,0,0\n \
27.08.2024,10:42:54,31.60,32.90,29.30,23.70,0.1,0,849,849,848,0,0,0\n \
27.08.2024,10:43:03,32.10,33.50,29.50,23.70,0.1,0,849,849,848,0,0,0\n \
27.08.2024,10:43:14,32.40,33.90,29.50,23.70,0.1,0,849,849,848,0,0,0\n \
27.08.2024,10:43:24,32.80,34.50,29.70,23.80,0.1,0,849,849,847,0,0,0\n \
27.08.2024,10:43:33,33.20,34.80,29.80,23.90,0.1,0,849,849,847,0,0,0\n \
27.08.2024,10:43:44,33.40,35.20,30.00,24.10,0.1,0,849,849,847,0,0,0";
send("%WRITEPROTOCOL " + data);
}

function getProtocolString(entry){
	return(
		entry.date + ',' +
		entry.time + ',' +
		entry.T1 + ',' +
		entry.T2 + ',' +
		entry.T3 + ',' +
		entry.T4 + ',' +
		entry.Nir1 + ',' +
		entry.Nir2 + ',' +
		entry.Ir1 + ',' +
		entry.Ir2 + ',' +
		entry.Ir3 + ',' +
		entry.Vis1 + ',' +
		entry.Vis2 + ',' +
		entry.Vis3
		);
}

toggleMesssages = function(){
	if( document.getElementById("debugpart").style.display == 'block')
		document.getElementById("debugpart").style.display = 'none';
	else
		document.getElementById("debugpart").style.display = 'block';
};

toggleAdmin = function(){
	if( document.getElementById("adminpart").style.display == 'block')
		document.getElementById("adminpart").style.display = 'none';
	else{
		send_msg("%SERIAL");
		send_msg("#READOPS");
		document.getElementById("adminpart").style.display = 'block';
	//	document.getElementById("systime").innerText =
	//		document.getElementById("devicetime").innerText;
	}
};

toggleCommandReference = function(){
	if( document.getElementById("commandpart").style.display == 'block')
		document.getElementById("commandpart").style.display = 'none';
	else
		document.getElementById("commandpart").style.display = 'block';
};


function dropdownclick() {
  document.getElementById("myDropdown").classList.toggle("show");
}

function initPage(){
/*	window.setInterval( function(){
		document.getElementById("currenttime").innerText = now();} , 1000); */
	window.setInterval( function(){
			let now = new Date();
			if (now.getTime() - lastresponse > 20000){
				document.getElementById("state").innerText = "Keine Verbindung";
				document.getElementById("state").style.color = "orange";
			}
			send("#STATUS\n\r");
			send("#READCHANNELS\n\r");
			} , 10000);
	window.setInterval( function(){
			send("#TIME\n\r");
			} , 60000);
	send("#TIME\n\r");
	send("#STATUS\n\r");
	send("#READTEMPERATURES\n\r");
	send("#READVALUES\n\r");
	send("#READCHANNELS\n\r");
}

function choosePort(port){
	req = new XMLHttpRequest();
	req.open("GET", "connect?" + port, false);
	req.send(null);
	let response = req.responseText;
	document.getElementById("activeconnection").innerText = port;
}

function loadPortlist(){
	req = new XMLHttpRequest();
	req.open("GET", "portlist", false);
	req.send(null);
	let portlist = JSON.parse(req.responseText);
	let dd = document.getElementById("myDropdown");
	dd.innerHTML = '';
	for (var i = 0; i < portlist.length; i++){
		var link = document.createElement("A");
		link.href="#" + portlist[i].port;
		link.innerHTML = '<span style="padding-right:5px;">' + portlist[i].port + "</span><span>('" + portlist[i].manufacturer + "')</span>";
		dd.appendChild(link);
	}
	var refresh = document.createElement("A");
	refresh.href="#refresh";
	refresh.onclick="loadPortlist()";
	refresh.innerText = "Refresh";
	dd.appendChild(refresh);
}

function send(data){
 socket.emit('send', { Data: data} );
}

function send_msg(data) {
  var txt = document.getElementById("msg").value;
  txt = txt + data + '\r';
  socket.emit('send', { Data: txt} );
  document.getElementById("msg").value = "";
  document.sendform.msg.focus();
}

let lastresponse = 0;

function getVisCurrent(mV){
	//return (parseInt (mV/500 / .036)) / 10;
	// 0.036 / 1.21
	return (parseInt (mV/500 / .0298)) / 10;
};

function getNirCurrent(mV){
	return (parseInt (mV/500 / .0195)) / 10;
};

function getIrPower(mV){
	if (mV > 750)
		return parseInt(mV * .82 - 474);
	else 
		return 0;
};


function onResponse(data){
	let Vars;
	let now = new Date();
	lastresponse = now.getTime();
	switch (getCommand(data)){
		case "#TIME": 
			// set the time
			Vars = /#TIME: (\d*)-(\d*)-(\d*)T([\d:\d]*):\d\d/mg.exec(data);
			document.getElementById("devicetime").innerText = 
				Vars[3]+"."+Vars[2]+"."+Vars[1]+" "+Vars[4];
			break;
		case "#READTEMPERATURES":
			Vars = /#READTEMPERATURES: \[(.*),(.*),(.*),(.*).*/mg.exec(data);
			document.getElementById("tlamp1").innerText = Vars[1];
			document.getElementById("tlamp2").innerText = Vars[2];
			document.getElementById("tlamp3").innerText = Vars[3];
			document.getElementById("telectronic").innerText = Vars[4];
			break;
		case "#READCHANNEL":
			Vars = /#READCHANNEL:.*Channel:(\d*) Value\[mV\]:([\d]*)/gm.exec(data);
			if (parseInt(Vars[1]) == 15){
				document.getElementById("POTRange").value = parseInt(Vars[2]);
				document.getElementById("demoPOT").innerText = Vars[2];
				}
			break;
		case "#READDACCHANNELS":
			Vars = /#READDACCHANNELS: \[(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*).*/gm.exec(data);
				// VIS 
				let i, visible=0,infrared=0,ninfrared=0;;
				for (i=0;i<vis_dac.length;i++)
					visible+=parseInt(Vars[vis_dac[i]+1]);
				visible = visible/vis_dac.length/4095*100;
				sliderVIS.value = visible;
				outputVIS.innerHTML = sliderVIS.value+ "%"; 
				for (i=0;i<ir_dac.length;i++)
					infrared+=parseInt(Vars[ir_dac[i]+1]);
				infrared = infrared/ir_dac.length/4095*100;
				sliderIR.value = infrared;
				outputIR.innerHTML = sliderIR.value+ "%"; 
				for (i=0;i<nir_dac.length;i++)
					ninfrared+=parseInt(Vars[nir_dac[i]+1]);
				ninfrared = ninfrared/nir_dac.length/4095*100;
				sliderNIR.value = ninfrared;
				outputNIR.innerHTML = sliderNIR.value+ "%"; 
			break;
		case "#READCHANNELS":
			Vars=
			/#READCHANNELS: \[(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*),(.*).*/gm
				.exec(data);
			let T1 = Vars[1];	
			let T2 = Vars[2];
			let T3 = Vars[3];
			let T4 = Vars[4];
			let Nir1 = getNirCurrent(Vars[12]);
			let Nir2 = getNirCurrent(Vars[5]);
			let Ir1 = getIrPower(Vars[9]);
			let Ir2 = getIrPower(Vars[8]);
			let Ir3 = getIrPower(Vars[10]);
			let Vis1 = getVisCurrent(Vars[7]);
			let Vis2 = getVisCurrent(Vars[11]);
			let Vis3 = getVisCurrent(Vars[6]);

			document.getElementById("tlamp1").innerText = T1;
			document.getElementById("tlamp2").innerText = T2;
			document.getElementById("tlamp3").innerText = T3;
			document.getElementById("telectronic").innerText = T4;
			document.getElementById("nir1act").innerText = Nir1;
			document.getElementById("nir2act").innerText = Nir2;
			document.getElementById("ir1act").innerText = Ir1;
			document.getElementById("ir2act").innerText = Ir2;
			document.getElementById("ir3act").innerText = Ir3;
			document.getElementById("vis1act").innerText = Vis1;
			document.getElementById("vis2act").innerText = Vis2;
			document.getElementById("vis3act").innerText = Vis3;
			// Protocol file
			if (document.getElementById("state").innerText == "Aktiv"){
				let date = Now(true);
				let newProtEntry = { "date": date.split(" ")[0],"time": date.split(" ")[1],
					"T1":  T1, "T2":  T2, "T3":  T3, "T4":  T4, 
					"Nir1":  Nir1, "Nir2":  Nir2, 
					"Ir1":  Ir1, "Ir2":  Ir2, "Ir3":  Ir3,  
					"Vis1":  Vis1, "Vis2":  Vis2, "Vis3":  Vis3, 
					};
				if(!protocol || !protocol.entries){
					protocol.name = Now().toString().replace(" ", "-");
					protocol.entries = new Array();
				}
				protocol.entries.push(newProtEntry);
			}
			// Poti (15)
			document.getElementById("POTRange").value = parseInt(parseInt(Vars[16])/2048 * 100) ;
			document.getElementById("demoPOT").innerText = parseInt(parseInt(Vars[16])/2048 * 100) + "%";
			break;
		case "#STATUS":
		case "#STARTSTOP":
			let status=data.split(":")[1].trim();
			if (status.indexOf("\r")!=-1)
				status=status.split("\r\n")[0];
			if (status == 'starting'){
				startstop.innerText="...";
				document.getElementById("state").innerText = "Startet...";
				document.getElementById("state").style.color = "orange";				
			}
			else if (status == 'active'){
				startstop.innerText="Stop";
				document.getElementById("state").innerText = "Aktiv";
				document.getElementById("state").style.color = "black";
				}
			else if (status == 'setting'){
				document.getElementById("state").innerText = "Busy";
				document.getElementById("state").style.color = "orange";					
				}			
			else{
				startstop.innerText="Start";
				if (status == "standby"){
					document.getElementById("state").innerText = "Bereit";
					document.getElementById("state").style.color = "black";
					}
				else if (status == "phase"){
					document.getElementById("state").innerText = "Spannungsfehler";
					document.getElementById("state").style.color = "red";
					startstop.innerText="...";
				}
				else if (status == "temperature"){
					document.getElementById("state").innerText = "Überhitzung";
					document.getElementById("state").style.color = "red";
					startstop.innerText="...";
					}
				}
			break;
		case "#READVALUES":
			Vars=
			/#READVALUES: ([-,\d.]*) (.*) (.*) (.*).*/gm.exec(data);
			sliderPOS.value = Vars[1];
			outputPOS.innerHTML = sliderPOS.value + "°"; 
			sliderVIS.value = Vars[2];
			outputVIS.innerHTML = sliderVIS.value + "%"; 
			sliderNIR.value = Vars[3];
			outputNIR.innerHTML = sliderNIR.value + "%"; 
			sliderIR.value = Vars[4];
			outputIR.innerHTML = sliderIR.value + "%"; 
			break;
		case "#READOPS":
			Vars= data.split('#READOPS:')[1];
			try{
			// let oOps=JSON.parse(Vars);
			let opmin=JSON.parse(Vars).total
			let hours=parseInt(opmin/60);
			let minutes=opmin-hours*60;
			let out="";
			if (hours < 10)
				out='0' + hours;
			else
				out = hours;
			if (minutes < 10)
				out= out + ':0' + minutes;
			else
				out = out + ':' + minutes;
			document.getElementById('ophours').innerText = out;
			}catch(e){};
			break;
		case "%SERIAL":
			Vars = data.split(' ')[1];
			Vars = Vars.split('\r');
			document.getElementById('serial').innerText = Vars[0];
			break;
		default:	
	}
}

// extract the command string from the response data
function getCommand(data){
	try{
	return( data.split(":")[0]);
	}
	catch(e){
		return("ERROR");
	}
}

function zeroFill(i) { return (i < 10 ? '0' : '') + i }
function Now(withSeconds) {
  var d = new Date()
/*  return d.getFullYear() + '-'
    + zeroFill((d.getMonth() + 1)) + '-'
    + zeroFill(d.getDate())        + ' '
    + zeroFill(d.getHours())       + ':'
    + zeroFill(d.getMinutes())     + ':'
    + zeroFill(d.getSeconds()) */
	if (!withSeconds){
	return zeroFill(d.getDate())        + '.'
		+ zeroFill((d.getMonth() + 1))  + '.'
		+ d.getFullYear() 				+ ' '
		+ zeroFill(d.getHours())       	+ ':'
		+ zeroFill(d.getMinutes());
  	}
	return zeroFill(d.getDate())        + '.'
		+ zeroFill((d.getMonth() + 1))  + '.'
		+ d.getFullYear() 				+ ' '
		+ zeroFill(d.getHours())       	+ ':'
		+ zeroFill(d.getMinutes())		+ ':'
		+ zeroFill(d.getSeconds());
}
var text   = document.getElementById('text');
var socket = io.connect('http://localhost:8888');
let received="";
socket.on('data', function(data) {
//console.log(JSON.stringify(data));
  var msgs  = document.getElementById("text");
  var txt   = msgs.innerHTML;
  var rep   = data.data.replace(/\x0D\x0A/g,"XX<br />");
  txt       = txt + "<br>" /*+ now() + " " */+ rep;
  msgs.innerHTML = txt;
  msgs.scrollTop = msgs.scrollHeight;
  received=received+data.data;
  if (received.indexOf("\r\n") != -1){
	onResponse(received);
	received=received.substr(received.indexOf("\n")+1);
	}
 });

document.getElementById('msg').addEventListener('keypress', function(event) {
  if (event.keyCode == 13) {  send_msg("\n");  event.preventDefault(); }
});
document.sendform.msg.focus();

</script>
</body>
</html>